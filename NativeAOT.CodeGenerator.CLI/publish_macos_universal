#!/usr/bin/env bash

set -e

DOTNET_PATH=`which dotnet`

VERBOSITY_LEVEL="normal"

RUNTIME_IDENTIFIER_X64="osx-x64"
RUNTIME_IDENTIFIER_ARM64="osx-arm64"
RUNTIME_IDENTIFIER_UNIVERSAL="osx-universal"

BIN_DIR="bin"
PUBLISH_DIR="publish"

BUILD_CONFIGURATION="Release"
DOTNET_TARGET_FRAMEWORK="net8.0"

OUTPUT_FILE_NAME="NativeAOT.CodeGenerator.CLI"

X64_BUILD_DIR="${BIN_DIR}/${BUILD_CONFIGURATION}/${DOTNET_TARGET_FRAMEWORK}/${RUNTIME_IDENTIFIER_X64}/${PUBLISH_DIR}"
ARM64_BUILD_DIR="${BIN_DIR}/${BUILD_CONFIGURATION}/${DOTNET_TARGET_FRAMEWORK}/${RUNTIME_IDENTIFIER_ARM64}/${PUBLISH_DIR}"
UNIVERSAL_BUILD_DIR="${BIN_DIR}/${BUILD_CONFIGURATION}/${DOTNET_TARGET_FRAMEWORK}/${RUNTIME_IDENTIFIER_UNIVERSAL}/${PUBLISH_DIR}"

X64_FILE_PATH="${X64_BUILD_DIR}/${OUTPUT_FILE_NAME}"
ARM64_FILE_PATH="${ARM64_BUILD_DIR}/${OUTPUT_FILE_NAME}"
UNIVERSAL_FILE_PATH="${UNIVERSAL_BUILD_DIR}/${OUTPUT_FILE_NAME}"

echo "Building for x64"
${DOTNET_PATH} publish -r ${RUNTIME_IDENTIFIER_X64} -v "${VERBOSITY_LEVEL}"

echo "Building for ARM64"
${DOTNET_PATH} publish -r ${RUNTIME_IDENTIFIER_ARM64} -v "${VERBOSITY_LEVEL}"

echo "Making directory for universal build"
mkdir -p "${UNIVERSAL_BUILD_DIR}"

echo "Making universal build"
lipo -create "${X64_FILE_PATH}" "${ARM64_FILE_PATH}" -output "${UNIVERSAL_FILE_PATH}"

