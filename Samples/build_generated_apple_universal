#!/usr/bin/env bash

set -e

PRODUCT_NAME="BeyondDotNETSampleNative"
OUTPUT_PRODUCT_NAME="lib${PRODUCT_NAME}"

GENERATED_HEADER_FILE_NAME="Generated_C.h"
GENERATED_SWIFT_FILE_NAME="Generated_Swift.swift"
MODULEMAP_FILE_NAME="module.modulemap"
HEADERS_FILE_NAME=headers.yaml

echo "Copying Modulemap"
cp -f "${MODULEMAP_FILE_NAME}" "Generated/${MODULEMAP_FILE_NAME}"

echo "Copying Headers"
cp -f "${HEADERS_FILE_NAME}" "Generated/${HEADERS_FILE_NAME}"

cd "Generated"

DEPLOYMENT_TARGET_MACOS="13.0"
DEPLOYMENT_TARGET_IOS="16.0"

SWIFT_VERSION="5"

SDK_PATH_IOS=`xcrun --sdk iphoneos --show-sdk-path`
SDK_PATH_IOSSIMULATOR=`xcrun --sdk iphonesimulator --show-sdk-path`
SDK_PATH_MACOS=`xcrun --sdk macosx --show-sdk-path`

TARGET_IDENTIFIER_ARM64="arm64"
TARGET_IDENTIFIER_X64="x86_64"

RUNTIME_IDENTIFIER_ARM64="arm64"
RUNTIME_IDENTIFIER_X64="x64"

PLATFORM_IDENTIFIER_MACOS="apple-macos"
PLATFORM_IDENTIFIER_MACOS_DN="osx"

PLATFORM_IDENTIFIER_IOS="apple-ios"
PLATFORM_IDENTIFIER_IOS_DN="ios"

PLATFORM_IDENTIFIER_IOSSIMULATOR="apple-ios-simulator"
PLATFORM_IDENTIFIER_IOSSIMULATOR_DN="iossimulator"

PLATFORM_SUFFIX_IOSSIMULATOR="-simulator"

SWIFTMODULE_FILE_EXTENSION="swiftmodule"
SWIFTINTERFACE_FILE_EXTENSION="swiftinterface"

OUTPUT_PATH_ROOT="bin"
OUTPUT_PATH_APPLE="${OUTPUT_PATH_ROOT}/apple"

OUTPUT_PATH_APPLEMODULE="${OUTPUT_PATH_APPLE}/${PRODUCT_NAME}.${SWIFTMODULE_FILE_EXTENSION}"

OUTPUT_PATH_MACOS_ARM64="${OUTPUT_PATH_APPLE}/${PLATFORM_IDENTIFIER_MACOS_DN}-${RUNTIME_IDENTIFIER_ARM64}"
OUTPUT_PATH_MACOS_X64="${OUTPUT_PATH_APPLE}/${PLATFORM_IDENTIFIER_MACOS_DN}-${RUNTIME_IDENTIFIER_X64}"

OUTPUT_PATH_IOS_ARM64="${OUTPUT_PATH_APPLE}/${PLATFORM_IDENTIFIER_IOS_DN}-${RUNTIME_IDENTIFIER_ARM64}"
OUTPUT_PATH_IOSSIMULATOR_ARM64="${OUTPUT_PATH_APPLE}/${PLATFORM_IDENTIFIER_IOSSIMULATOR_DN}-${RUNTIME_IDENTIFIER_ARM64}"
OUTPUT_PATH_IOSSIMULATOR_X64="${OUTPUT_PATH_APPLE}/${PLATFORM_IDENTIFIER_IOSSIMULATOR_DN}-${RUNTIME_IDENTIFIER_X64}"

if [ -d "${OUTPUT_PATH_ROOT}" ] 
then
	echo "Removing output directory"
	rm -r "${OUTPUT_PATH_ROOT}"
fi

echo "Making output directories"
mkdir -p "${OUTPUT_PATH_APPLEMODULE}"

mkdir -p "${OUTPUT_PATH_MACOS_ARM64}"
mkdir -p "${OUTPUT_PATH_MACOS_X64}"

mkdir -p "${OUTPUT_PATH_IOS_ARM64}"

mkdir -p "${OUTPUT_PATH_IOSSIMULATOR_ARM64}"
mkdir -p "${OUTPUT_PATH_IOSSIMULATOR_X64}"

swift_compile() {
	local SDK=$1
	local TARGET_IDENTIFIER=$2
	local PLATFORM_IDENTIFIER=$3
	local PLATFORM_SUFFIX=$4
	local DEPLOYMENT_TARGET=$5
	local OUTPUT_PATH=$6

	local TARGET_DOUBLE="${TARGET_IDENTIFIER}-${PLATFORM_IDENTIFIER}"
	local TARGET_TRIPLE="${TARGET_DOUBLE}${DEPLOYMENT_TARGET}${PLATFORM_SUFFIX}"

	echo "Building for ${TARGET_TRIPLE}"

	xcrun \
		swiftc \
		-sdk "${SDK}" \
		-target "${TARGET_TRIPLE}" \
		-working-directory . \
		-I . \
		-Xcc -ivfsoverlay -Xcc "headers.yaml" \
		-F . \
		-O \
		-save-temps \
		-enable-testing \
		-enable-library-evolution \
		-enforce-exclusivity=checked \
		-enable-bare-slash-regex \
		-parse-as-library \
		-module-name "${PRODUCT_NAME}" \
		-module-link-name "${PRODUCT_NAME}" \
		-static \
		-emit-library \
		-emit-module-interface-path "${OUTPUT_PATH_APPLEMODULE}/${TARGET_DOUBLE}.${SWIFTINTERFACE_FILE_EXTENSION}" \
		-emit-private-module-interface-path "${OUTPUT_PATH_APPLEMODULE}/${TARGET_DOUBLE}.private.${SWIFTINTERFACE_FILE_EXTENSION}" \
		-o "${OUTPUT_PATH}/${OUTPUT_PRODUCT_NAME}.a" \
		-emit-objc-header \
		-emit-objc-header-path "${OUTPUT_PATH}/${OUTPUT_PRODUCT_NAME}-Swift.h" \
		-swift-version "${SWIFT_VERSION}" \
		-import-underlying-module \
		-experimental-emit-module-separately \
		-disable-cmo \
		-c "${GENERATED_SWIFT_FILE_NAME}"

	nm \
		-g \
		-U \
		"${OUTPUT_PATH}/${OUTPUT_PRODUCT_NAME}.a" | awk '!/(_associated conformance |_symbolic )/ {print $3}' > "${OUTPUT_PATH}/${OUTPUT_PRODUCT_NAME}.exports"
}

swift_compile "${SDK_PATH_MACOS}" "${TARGET_IDENTIFIER_ARM64}" "${PLATFORM_IDENTIFIER_MACOS}" "" "${DEPLOYMENT_TARGET_MACOS}" "${OUTPUT_PATH_MACOS_ARM64}"
swift_compile "${SDK_PATH_MACOS}" "${TARGET_IDENTIFIER_X64}" "${PLATFORM_IDENTIFIER_MACOS}" "" "${DEPLOYMENT_TARGET_MACOS}" "${OUTPUT_PATH_MACOS_X64}"
swift_compile "${SDK_PATH_IOS}" "${TARGET_IDENTIFIER_ARM64}" "${PLATFORM_IDENTIFIER_IOS}" "" "${DEPLOYMENT_TARGET_IOS}" "${OUTPUT_PATH_IOS_ARM64}"
swift_compile "${SDK_PATH_IOSSIMULATOR}" "${TARGET_IDENTIFIER_ARM64}" "${PLATFORM_IDENTIFIER_IOS}" "${PLATFORM_SUFFIX_IOSSIMULATOR}" "${DEPLOYMENT_TARGET_IOS}" "${OUTPUT_PATH_IOSSIMULATOR_ARM64}"
swift_compile "${SDK_PATH_IOSSIMULATOR}" "${TARGET_IDENTIFIER_X64}" "${PLATFORM_IDENTIFIER_IOS}" "${PLATFORM_SUFFIX_IOSSIMULATOR}" "${DEPLOYMENT_TARGET_IOS}" "${OUTPUT_PATH_IOSSIMULATOR_X64}"